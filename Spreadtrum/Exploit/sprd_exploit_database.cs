// ============================================================================
// LoveAlways - Spreadtrum Vulnerability Database
// ============================================================================

// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
// Eng Translation by iReverse - HadiKIT - Hadi Khoirudin, S.Kom.
// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


using System;
using System.Collections.Generic;
using System.Linq;
using LoveAlways.Spreadtrum.Protocol;

namespace LoveAlways.Spreadtrum.Exploit
{
    /// <summary>
    /// Spreadtrum Vulnerability Database
    /// </summary>
    public static class SprdExploitDatabase
    {
        // Known vulnerable chips
        private static readonly Dictionary<uint, List<SprdVulnerabilityInfo>> VulnerableChips = 
            new Dictionary<uint, List<SprdVulnerabilityInfo>>
        {
            // SC7731 Series - Early chips, most are vulnerable
            { 0x7731, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.FdlSignatureBypass,
                        Name = "SC7731 Signature Bypass",
                        Description = "Early SC7731 versions do not correctly verify FDL signature",
                        SuccessRate = 4,
                        AffectedChips = new[] { "SC7731", "SC7731C", "SC7731E" }
                    },
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.MemoryRead,
                        Name = "SC7731 Memory Read",
                        Description = "Sensitive memory areas can be read via BSL commands",
                        SuccessRate = 3,
                        AffectedChips = new[] { "SC7731" }
                    }
                }
            },

            // SC9820 Series
            { 0x9820, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.BslOverflow,
                        Name = "SC9820 BSL Overflow",
                        Description = "Buffer overflow vulnerability exists in BSL handshake phase",
                        SuccessRate = 3,
                        AffectedChips = new[] { "SC9820", "SC9820E" }
                    }
                }
            },

            // SC9830 Series
            { 0x9830, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.Downgrade,
                        Name = "SC9830 Downgrade Attack",
                        Description = "Older FDL versions can be used to bypass security checks",
                        SuccessRate = 3,
                        AffectedChips = new[] { "SC9830", "SC9830A" }
                    }
                }
            },

            // SC9832 Series
            { 0x9832, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.HdlcOverflow,
                        Name = "SC9832 HDLC Overflow",
                        Description = "Integer overflow exists in HDLC frame parsing",
                        SuccessRate = 2,
                        AffectedChips = new[] { "SC9832", "SC9832E" }
                    }
                }
            },

            // SC9850 Series
            { 0x9850, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.DebugMode,
                        Name = "SC9850 Debug Mode",
                        Description = "Certain firmware versions allow debug mode activation",
                        SuccessRate = 2,
                        AffectedChips = new[] { "SC9850KA" }
                    }
                }
            },

            // SC9863 Series
            { 0x9863, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.NvBypass,
                        Name = "SC9863 NV Bypass",
                        Description = "NV verification can be bypassed",
                        SuccessRate = 2,
                        AffectedChips = new[] { "SC9863A" }
                    }
                }
            },

            // T310 Series
            { 0x0310, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.Downgrade,
                        Name = "T310 Downgrade Attack",
                        Description = "Early Boot ROM versions can be downgraded",
                        SuccessRate = 2,
                        AffectedChips = new[] { "T310" }
                    }
                }
            },

            // T606/T612/T616 Series
            { 0x0606, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.MemoryRead,
                        Name = "T606 Memory Read",
                        Description = "Protected memory can be read under specific conditions",
                        SuccessRate = 2,
                        AffectedChips = new[] { "T606", "T612", "T616" }
                    }
                }
            },

            // T618/T700 Series - Newer chips, fewer vulnerabilities
            { 0x0618, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.DebugMode,
                        Name = "T618 Debug Probe",
                        Description = "Can attempt to activate engineering mode",
                        SuccessRate = 1,
                        AffectedChips = new[] { "T618" }
                    }
                }
            },

            // T610/T612/T616 Series - Mid-range chips
            { 0x0610, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.FdlSignatureBypass,
                        Name = "T610 Signature Bypass",
                        Description = "Signature validation vulnerability exists in certain firmware versions",
                        SuccessRate = 2,
                        AffectedChips = new[] { "T610", "T612", "T616" }
                    },
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.MemoryRead,
                        Name = "T610 Memory Read",
                        Description = "Protected memory can be read in BROM mode",
                        SuccessRate = 2,
                        AffectedChips = new[] { "T610" }
                    }
                }
            },

            // UMS512 系列
            { 0x0512, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.FdlSignatureBypass,
                        Name = "UMS512 Signature Bypass",
                        Description = "UMS512 early version signature validation can be bypassed",
                        SuccessRate = 2,
                        AffectedChips = new[] { "UMS512" }
                    }
                }
            },

            // T700/T760/T770 Series - High-end chips, higher security
            { 0x0700, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.Downgrade,
                        Name = "T700 Downgrade Probe",
                        Description = "Check for older FDL downgrade support",
                        SuccessRate = 1,
                        AffectedChips = new[] { "T700", "T760", "T770" }
                    }
                }
            },

            // SC8541E Series - Entry-level 4G
            { 0x8541, new List<SprdVulnerabilityInfo>
                {
                    new SprdVulnerabilityInfo
                    {
                        Type = SprdExploitType.NvBypass,
                        Name = "SC8541E NV Bypass",
                        Description = "NV verification logic may be bypassed",
                        SuccessRate = 2,
                        AffectedChips = new[] { "SC8541E" }
                    }
                }
            }
        };

        // Known Unfused PK Hashes (Test/Dev devices)
        private static readonly HashSet<string> UnfusedPkHashes = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "0000000000000000000000000000000000000000000000000000000000000000",
            "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF",
            "00000000000000000000000000000000",
            "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF"
        };

        /// <summary>
        /// Check device vulnerabilities
        /// </summary>
        public static SprdVulnerabilityCheckResult CheckVulnerabilities(uint chipId, string pkHash = null)
        {
            var result = new SprdVulnerabilityCheckResult
            {
                ChipId = chipId,
                PkHash = pkHash
            };

            // 1. Check if it's an Unfused device
            if (!string.IsNullOrEmpty(pkHash) && IsUnfusedDevice(pkHash))
            {
                result.HasVulnerability = true;
                result.IsUnfused = true;
                result.Reason = "Unfused device, any FDL can be loaded";
                result.RecommendedExploit = SprdExploitType.FdlSignatureBypass;
                result.AvailableExploits.Add(new SprdVulnerabilityInfo
                {
                    Type = SprdExploitType.FdlSignatureBypass,
                    Name = "Unfused Device",
                    Description = "Security key not fused, unsigned firmware can be loaded directly",
                    SuccessRate = 5
                });
                return result;
            }

            // 2. Check chip-specific vulnerabilities
            // Attempt exact match
            if (VulnerableChips.TryGetValue(chipId, out var vulns))
            {
                result.HasVulnerability = true;
                result.Reason = string.Format("Chip 0x{0:X} has known vulnerability", chipId);
                result.AvailableExploits.AddRange(vulns);
                result.RecommendedExploit = vulns.OrderByDescending(v => v.SuccessRate).First().Type;
                return result;
            }

            // Attempt series match
            uint chipSeries = GetChipSeries(chipId);
            if (VulnerableChips.TryGetValue(chipSeries, out vulns))
            {
                result.HasVulnerability = true;
                result.Reason = string.Format("Chip series 0x{0:X} has known vulnerability", chipSeries);
                result.AvailableExploits.AddRange(vulns);
                result.RecommendedExploit = vulns.OrderByDescending(v => v.SuccessRate).First().Type;
                return result;
            }

            // 3. Vulnerability not found
            result.HasVulnerability = false;
            result.Reason = "No known vulnerability detected";
            return result;
        }

        /// <summary>
        /// Check if it's an Unfused device
        /// </summary>
        public static bool IsUnfusedDevice(string pkHash)
        {
            if (string.IsNullOrEmpty(pkHash))
                return false;

            // Check known Unfused Hashes
            if (UnfusedPkHashes.Contains(pkHash))
                return true;

            // Check all zeros or all Fs
            if (pkHash.All(c => c == '0') || pkHash.All(c => c == 'F' || c == 'f'))
                return true;

            return false;
        }

        /// <summary>
        /// Get chip series
        /// </summary>
        private static uint GetChipSeries(uint chipId)
        {
            // SC77xx Series
            if (chipId >= 0x7700 && chipId < 0x7800)
                return 0x7731;

            // SC98xx Series
            if (chipId >= 0x9800 && chipId < 0x9900)
            {
                if (chipId >= 0x9860)
                    return 0x9863;
                if (chipId >= 0x9850)
                    return 0x9850;
                if (chipId >= 0x9830)
                    return 0x9832;
                return 0x9820;
            }

            // T3xx Series
            if (chipId >= 0x0300 && chipId < 0x0400)
                return 0x0310;

            // T6xx Series
            if (chipId >= 0x0600 && chipId < 0x0700)
            {
                if (chipId >= 0x0618)
                    return 0x0618;
                return 0x0606;
            }

            return chipId;
        }

        /// <summary>
        /// Get chip name
        /// </summary>
        public static string GetChipName(uint chipId)
        {
            return SprdPlatform.GetPlatformName(chipId);
        }

        /// <summary>
        /// Get all known vulnerabilities
        /// </summary>
        public static List<SprdVulnerabilityInfo> GetAllKnownVulnerabilities()
        {
            var all = new List<SprdVulnerabilityInfo>();
            foreach (var kvp in VulnerableChips)
            {
                all.AddRange(kvp.Value);
            }
            return all.Distinct().ToList();
        }

        /// <summary>
        /// Get affected chips by vulnerability type
        /// </summary>
        public static List<uint> GetAffectedChips(SprdExploitType exploitType)
        {
            var chips = new List<uint>();
            foreach (var kvp in VulnerableChips)
            {
                if (kvp.Value.Any(v => v.Type == exploitType))
                {
                    chips.Add(kvp.Key);
                }
            }
            return chips;
        }
    }
}
